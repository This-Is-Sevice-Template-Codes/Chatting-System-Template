<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>STOMP Chat Tester</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .msg { padding: 5px; margin: 2px; border-radius: 4px; }
    .me { background: #dcf8c6; text-align: right; }
    .other { background: #eee; }
    .sys { text-align: center; color: #888; font-size: 0.8em; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>Chat Client (STOMP)</h1>
<div>
  <input id="senderId" placeholder="Sender ID (1)">
  <input id="roomId" placeholder="Room ID (1)">
  <button onclick="connect()">Connect</button>
</div>
<div id="chatBox" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; margin: 10px 0;"></div>
<div>
  <input id="msg" placeholder="Message">
  <button onclick="send()">Send</button>
</div>

<script>
  let stompClient = null;

  function connect() {
    const socket = new WebSocket('ws://localhost:8086/ws-chat');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function () {
      console.log('Connected');
      const roomId = document.getElementById('roomId').value;
      const senderId = document.getElementById('senderId').value;

      // 구독
      stompClient.subscribe('/sub/chat/room/' + roomId, function (msg) {
        showMsg(JSON.parse(msg.body));
      });

      // 입장 요청
      stompClient.send("/pub/chat/enter", {}, JSON.stringify({
        roomId: roomId, senderId: senderId
      }));
    });
  }

  function send() {
    const roomId = document.getElementById('roomId').value;
    const senderId = document.getElementById('senderId').value;
    const content = document.getElementById('msg').value;

    stompClient.send("/pub/chat/message", {}, JSON.stringify({
      roomId: roomId, senderId: senderId, content: content, msgType: 'TALK'
    }));
    document.getElementById('msg').value = '';
  }

  function showMsg(data) {
    const div = document.createElement('div');
    div.className = 'msg ' + (data.msgType === 'ENTER' ? 'sys' : (data.senderId == document.getElementById('senderId').value ? 'me' : 'other'));
    div.innerText = data.msgType === 'ENTER' ? data.content : `${data.senderId}: ${data.content} (${data.sendTime})`;
    document.getElementById('chatBox').appendChild(div);
  }
</script>
</body>
</html>