<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Chat Test Client</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .container { display: grid; gap: 10px; }
    .box { border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #f9f9f9; }
    #chat-box { height: 400px; overflow-y: scroll; background: white; border: 1px solid #ccc; padding: 10px; }
    .msg { margin-bottom: 5px; padding: 5px; border-radius: 4px; }
    .msg.me { background: #dcf8c6; text-align: right; }
    .msg.other { background: #eee; }
    .msg.sys { text-align: center; color: #888; font-size: 0.8em; }
    input, button { padding: 8px; margin-right: 5px; }
    .status { font-weight: bold; color: red; }
    .status.connected { color: green; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<h1>ğŸ’¬ Real-time Chat Tester</h1>

<div class="container">
  <div class="box">
    <h3>1. Connection & Room</h3>
    <div>
      <label>Sender ID (User PK):</label>
      <input type="number" id="senderId" value="1" placeholder="User ID">
    </div>
    <div>
      <label>Room ID:</label>
      <input type="number" id="roomId" value="1" placeholder="Room ID">
    </div>
    <div style="margin-top: 10px;">
      <button onclick="connect()" id="btnConnect">Connect & Enter</button>
      <button onclick="disconnect()" id="btnDisconnect" disabled>Disconnect</button>
      <span class="status" id="status">Disconnected</span>
    </div>
  </div>

  <div class="box">
    <h3>2. Chat</h3>
    <div id="chat-box"></div>
    <div style="margin-top: 10px; display: flex;">
      <input type="text" id="message" style="flex: 1;" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.keyCode==13) sendMessage()">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
  let stompClient = null;
  let currentSubscription = null;

  // 1. ì—°ê²° ë° ì…ì¥
  function connect() {
    const senderId = document.getElementById('senderId').value;
    const roomId = document.getElementById('roomId').value;

    // ë°±ì—”ë“œ WebSocketConfigì— ì„¤ì •ëœ ì—”ë“œí¬ì¸íŠ¸
    const socket = new WebSocket('ws://localhost:8080/ws-chat');
    stompClient = Stomp.over(socket);

    // ë””ë²„ê¹… ë¡œê·¸ ë„ê¸° (ì›í•˜ë©´ ì£¼ì„ í•´ì œ)
    // stompClient.debug = null;

    stompClient.connect({}, function (frame) {
      setConnected(true);
      console.log('Connected: ' + frame);

      // 1) êµ¬ë… (Subscribe): /sub/chat/room/{roomId}
      const subPath = '/sub/chat/room/' + roomId;
      currentSubscription = stompClient.subscribe(subPath, function (message) {
        showGreeting(JSON.parse(message.body));
      });
      console.log(`Subscribed to ${subPath}`);

      // 2) ì…ì¥ ë©”ì‹œì§€ ì „ì†¡ (Publish): /pub/chat/enter
      // ChatService.enterRoom() íŠ¸ë¦¬ê±° -> DB Insert/Update ìˆ˜í–‰
      stompClient.send("/pub/chat/enter", {}, JSON.stringify({
        'senderId': senderId,
        'roomId': roomId
      }));

    }, function (error) {
      console.error('STOMP error:', error);
      alert('ì—°ê²° ì‹¤íŒ¨: ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
    });
  }

  // 2. ì—°ê²° í•´ì œ
  function disconnect() {
    if (stompClient !== null) {
      stompClient.disconnect();
    }
    setConnected(false);
    console.log("Disconnected");
  }

  // 3. ë©”ì‹œì§€ ì „ì†¡
  function sendMessage() {
    const senderId = document.getElementById('senderId').value;
    const roomId = document.getElementById('roomId').value;
    const messageContent = document.getElementById('message').value;

    if (!stompClient || !messageContent) return;

    // ë°œí–‰ (Publish): /pub/chat/message
    stompClient.send("/pub/chat/message", {}, JSON.stringify({
      'senderId': senderId,
      'roomId': roomId,
      'content': messageContent,
      'msgType': 'TALK'
    }));

    document.getElementById('message').value = '';
  }

  // UI ì—…ë°ì´íŠ¸
  function showGreeting(message) {
    const chatBox = document.getElementById('chat-box');
    const myId = document.getElementById('senderId').value;

    const div = document.createElement('div');
    div.classList.add('msg');

    if (message.msgType === 'ENTER') {
      div.classList.add('sys');
      div.innerText = `[ì•Œë¦¼] ${message.content}`;
    } else {
      // ë‚´ ë©”ì‹œì§€ì¸ì§€ ë‚¨ì˜ ë©”ì‹œì§€ì¸ì§€ êµ¬ë¶„
      // ì£¼ì˜: ì‹¤ì œë¡œëŠ” senderIdê°€ Long/String ì¼ì¹˜ ì—¬ë¶€ í™•ì¸ í•„ìš”
      if (String(message.senderId) === String(myId)) {
        div.classList.add('me');
        div.innerText = `${message.content} : ë‚˜`;
      } else {
        div.classList.add('other');
        div.innerText = `User(${message.senderId}) : ${message.content}`;
      }
    }

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
  }

  function setConnected(connected) {
    document.getElementById('btnConnect').disabled = connected;
    document.getElementById('btnDisconnect').disabled = !connected;
    document.getElementById('senderId').disabled = connected;
    document.getElementById('roomId').disabled = connected;
    const status = document.getElementById('status');

    if (connected) {
      status.innerText = "Connected";
      status.classList.add('connected');
    } else {
      status.innerText = "Disconnected";
      status.classList.remove('connected');
      document.getElementById('chat-box').innerHTML = '';
    }
  }
</script>

</body>
</html>
